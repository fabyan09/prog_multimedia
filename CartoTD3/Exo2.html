<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice 2 - Objets G√©olocalis√©s dans Cam√©ra</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Babylon.js pour la 3D et l'AR -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            position: relative;
        }

        /* Canvas Babylon.js */
        #renderCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            touch-action: none;
        }

        /* Interface de contr√¥le */
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            color: #00ff88;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            transform: scale(1.05);
        }

        .control-btn.active {
            background: #00ff88;
            color: #000;
        }

        /* Informations de g√©olocalisation */
        #geoloc-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        #geoloc-info h3 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        #geoloc-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* Compas 2D */
        #compass {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            border-radius: 50%;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 40px;
            background: #ff4757;
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            transition: transform 0.3s ease;
        }

        .compass-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .compass-label {
            position: absolute;
            font-size: 12px;
            font-weight: bold;
        }

        .compass-n { top: 5px; left: 50%; transform: translateX(-50%); }
        .compass-s { bottom: 5px; left: 50%; transform: translateX(-50%); }
        .compass-e { right: 5px; top: 50%; transform: translateY(-50%); }
        .compass-w { left: 5px; top: 50%; transform: translateY(-50%); }

        /* Messages */
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #00ff88;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
            max-width: 300px;
        }

        #message.show {
            opacity: 1;
        }

        /* Loading */
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            #controls {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .control-btn {
                padding: 8px 12px;
                font-size: 11px;
            }

            #geoloc-info {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                max-width: 250px;
            }

            #compass {
                top: 10px;
                left: 10px;
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Message de chargement -->
    <div id="message" class="show">
        <div class="spinner"></div>
        <h3>Demande d'autorisation</h3>
        <p>Autorisation requise pour :</p>
        <p>üì∑ Acc√®s √† la cam√©ra</p>
        <p>üìç G√©olocalisation</p>
    </div>

    <!-- Canvas Babylon.js -->
    <canvas id="renderCanvas"></canvas>

    <!-- Compas 2D -->
    <div id="compass">
        <div class="compass-needle" id="compass-needle"></div>
        <div class="compass-center"></div>
        <div class="compass-label compass-n">N</div>
        <div class="compass-label compass-s">S</div>
        <div class="compass-label compass-e">E</div>
        <div class="compass-label compass-w">W</div>
    </div>

    <!-- Informations de g√©olocalisation -->
    <div id="geoloc-info">
        <h3>üìç Position GPS</h3>
        <p><strong>Latitude:</strong> <span id="lat">--</span></p>
        <p><strong>Longitude:</strong> <span id="lon">--</span></p>
        <p><strong>Altitude:</strong> <span id="alt">--</span> m</p>
        <p><strong>Pr√©cision:</strong> <span id="accuracy">--</span> m</p>
        <p><strong>Orientation:</strong> <span id="heading">--</span>¬∞</p>
        <p><strong>Vitesse:</strong> <span id="speed">--</span> km/h</p>
    </div>

    <!-- Contr√¥les -->
    <div id="controls">
        <button class="control-btn" id="requestCamera">üì∑ Cam√©ra</button>
        <button class="control-btn" id="toggleGeoloc">üìç G√©oloc</button>
        <button class="control-btn" id="toggleCompass">üß≠ Compas</button>
        <button class="control-btn" id="addObject">‚ûï Objet</button>
        <button class="control-btn" id="clearObjects">üóëÔ∏è Effacer</button>
        <button class="control-btn" id="toggleDebug">üêõ Debug</button>
    </div>

    <script>
        const canvas = document.getElementById('renderCanvas');
        const engine = new BABYLON.Engine(canvas, true);
        const message = document.getElementById('message');
        const geolocInfo = document.getElementById('geoloc-info');
        const compassNeedle = document.getElementById('compass-needle');

        // --- Param√®tres de la sc√®ne ---
        const distance = 50; // Distance des objets g√©olocalis√©s
        const cubeSize = 2;
        const smoothingFactor = 0.05;

        // Variables pour le lissage de l'orientation
        let targetAngleY = 0;
        let smoothedAngleY = 0;
        let currentPosition = null;
        let geolocationWatchId = null;
        let isGeolocationEnabled = true;
        let isCompassVisible = true;
        let objectCounter = 0;
        let customObjects = [];

        const createScene = () => {
            const scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0, 0, 0);
            
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 1.0;
            
            const camera = new BABYLON.FreeCamera("camera", new BABYLON.Vector3(0, 0, 0), scene);
            camera.setTarget(BABYLON.Vector3.Zero());
            
            // Objets g√©olocalis√©s fixes (monuments c√©l√®bres)
            createGeolocatedObjects(scene);
            
            // Initialiser la cam√©ra et l'orientation
            setupARBackground(scene);
            setupOrientationListener();
            initGeolocation();

            return scene;
        };

        const createGeolocatedObjects = (scene) => {
            // Tour Eiffel (Paris) - Nord
            const tourEiffel = BABYLON.MeshBuilder.CreateBox("TourEiffel", { size: cubeSize * 2 }, scene);
            tourEiffel.position = new BABYLON.Vector3(0, cubeSize, distance);
            const matTourEiffel = new BABYLON.StandardMaterial("matTourEiffel", scene);
            matTourEiffel.emissiveColor = BABYLON.Color3.Red();
            matTourEiffel.diffuseColor = BABYLON.Color3.Red();
            tourEiffel.material = matTourEiffel;
            
            // Big Ben (Londres) - Est
            const bigBen = BABYLON.MeshBuilder.CreateCylinder("BigBen", { height: cubeSize * 3, diameter: cubeSize }, scene);
            bigBen.position = new BABYLON.Vector3(distance, cubeSize * 1.5, 0);
            const matBigBen = new BABYLON.StandardMaterial("matBigBen", scene);
            matBigBen.emissiveColor = BABYLON.Color3.Blue();
            matBigBen.diffuseColor = BABYLON.Color3.Blue();
            bigBen.material = matBigBen;
            
            // Empire State (New York) - Sud
            const empireState = BABYLON.MeshBuilder.CreateBox("EmpireState", { size: cubeSize * 1.5 }, scene);
            empireState.position = new BABYLON.Vector3(0, cubeSize * 2, -distance);
            const matEmpireState = new BABYLON.StandardMaterial("matEmpireState", scene);
            matEmpireState.emissiveColor = BABYLON.Color3.Yellow();
            matEmpireState.diffuseColor = BABYLON.Color3.Yellow();
            empireState.material = matEmpireState;
            
            // Objet √† votre position actuelle - Ouest
            const currentObj = BABYLON.MeshBuilder.CreateSphere("CurrentPos", { diameter: cubeSize }, scene);
            currentObj.position = new BABYLON.Vector3(-distance, cubeSize, 0);
            const matCurrent = new BABYLON.StandardMaterial("matCurrent", scene);
            matCurrent.emissiveColor = BABYLON.Color3.Green();
            matCurrent.diffuseColor = BABYLON.Color3.Green();
            currentObj.material = matCurrent;
            
            // Animations
            BABYLON.Animation.CreateAndStartAnimation("tourEiffelRot", tourEiffel, "rotation.y", 60, 120, 0, Math.PI * 2, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);
            BABYLON.Animation.CreateAndStartAnimation("bigBenRot", bigBen, "rotation.y", 60, 80, 0, Math.PI * 2, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);
            BABYLON.Animation.CreateAndStartAnimation("currentPulse", currentObj, "scaling", 60, 30, new BABYLON.Vector3(1, 1, 1), new BABYLON.Vector3(1.2, 1.2, 1.2), BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);
        };

        const setupARBackground = (scene) => {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                const video = document.createElement('video');
                video.setAttribute('playsinline', '');
                video.setAttribute('autoplay', '');
                video.setAttribute('muted', '');
                video.srcObject = stream;
                video.play();
                
                const background = new BABYLON.Layer("background", null, scene, true);
                background.texture = new BABYLON.VideoTexture("video", video, scene, true);
                
                showMessage('‚úÖ Cam√©ra activ√©e !', 'success');
                hideMessage();
            })
            .catch(err => {
                console.error('Erreur cam√©ra:', err);
                showMessage('Erreur: Cam√©ra inaccessible. Assurez-vous d\'utiliser HTTPS.', 'error');
            });
        };

        const setupOrientationListener = () => {
            window.addEventListener("deviceorientationabsolute", (event) => {
                if (event.alpha !== null) {
                    // Correction avec l'angle de l'√©cran
                    const screenAngle = screen.orientation.angle || 0;
                    const compensatedAlpha = event.alpha - screenAngle;

                    targetAngleY = -compensatedAlpha;
                    updateCompass(compensatedAlpha);
                }
            }, true);
        };

        const initGeolocation = () => {
            if (!navigator.geolocation) {
                showMessage('G√©olocalisation non support√©e', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentPosition = position;
                    updateGeolocationInfo(position);
                    showMessage('‚úÖ G√©olocalisation activ√©e !', 'success');
                },
                (error) => {
                    console.error('Erreur g√©olocalisation:', error);
                    showMessage('Erreur g√©olocalisation: ' + error.message, 'error');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );

            geolocationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentPosition = position;
                    updateGeolocationInfo(position);
                },
                (error) => {
                    console.error('Erreur g√©olocalisation:', error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 1000 }
            );
        };

        const updateGeolocationInfo = (position) => {
            const coords = position.coords;
            document.getElementById('lat').textContent = coords.latitude.toFixed(6);
            document.getElementById('lon').textContent = coords.longitude.toFixed(6);
            document.getElementById('alt').textContent = coords.altitude ? coords.altitude.toFixed(1) : 'N/A';
            document.getElementById('accuracy').textContent = coords.accuracy.toFixed(1);
            document.getElementById('heading').textContent = coords.heading ? coords.heading.toFixed(1) : 'N/A';
            document.getElementById('speed').textContent = coords.speed ? (coords.speed * 3.6).toFixed(1) : 'N/A';
        };

        const updateCompass = (heading) => {
            if (heading !== null && compassNeedle) {
                compassNeedle.style.transform = `translate(-50%, -100%) rotate(${heading}deg)`;
            }
        };

        const addGeolocatedObject = () => {
            if (!currentPosition) {
                showMessage('Position GPS requise', 'error');
                return;
            }

            objectCounter++;
            const angle = (objectCounter * 45) % 360; // R√©partir les objets
            const radians = (angle * Math.PI) / 180;
            const x = Math.cos(radians) * distance;
            const z = Math.sin(radians) * distance;

            const object = BABYLON.MeshBuilder.CreateSphere(`CustomObj${objectCounter}`, { diameter: cubeSize }, scene);
            object.position = new BABYLON.Vector3(x, cubeSize, z);
            
            const material = new BABYLON.StandardMaterial(`matCustom${objectCounter}`, scene);
            material.emissiveColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());
            object.material = material;

            customObjects.push(object);
            showMessage(`Objet ${objectCounter} ajout√©`, 'success');
        };

        const clearCustomObjects = () => {
            customObjects.forEach(obj => obj.dispose());
            customObjects = [];
            objectCounter = 0;
            showMessage('Objets supprim√©s', 'success');
        };

        const toggleGeolocation = () => {
            const btn = document.getElementById('toggleGeoloc');
            
            if (isGeolocationEnabled) {
                if (geolocationWatchId) {
                    navigator.geolocation.clearWatch(geolocationWatchId);
                    geolocationWatchId = null;
                }
                isGeolocationEnabled = false;
                btn.classList.add('active');
                btn.textContent = 'üìç G√©oloc (OFF)';
                showMessage('G√©olocalisation d√©sactiv√©e', 'error');
            } else {
                initGeolocation();
                isGeolocationEnabled = true;
                btn.classList.remove('active');
                btn.textContent = 'üìç G√©oloc';
                showMessage('G√©olocalisation r√©activ√©e', 'success');
            }
        };

        const toggleCompass = () => {
            const compass = document.getElementById('compass');
            const btn = document.getElementById('toggleCompass');
            
            isCompassVisible = !isCompassVisible;
            compass.style.display = isCompassVisible ? 'block' : 'none';
            
            if (isCompassVisible) {
                btn.classList.remove('active');
                btn.textContent = 'üß≠ Compas';
            } else {
                btn.classList.add('active');
                btn.textContent = 'üß≠ Compas (OFF)';
            }
        };

        const showMessage = (text, type = 'success') => {
            message.innerHTML = `<h3>${text}</h3>`;
            message.className = `show ${type}`;
            
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        };

        const hideMessage = () => {
            message.classList.remove('show');
        };

        // Setup des √©v√©nements
        document.getElementById('requestCamera').addEventListener('click', () => {
            setupARBackground(scene);
        });
        document.getElementById('toggleGeoloc').addEventListener('click', toggleGeolocation);
        document.getElementById('toggleCompass').addEventListener('click', toggleCompass);
        document.getElementById('addObject').addEventListener('click', addGeolocatedObject);
        document.getElementById('clearObjects').addEventListener('click', clearCustomObjects);

        // Cr√©er la sc√®ne
        const scene = createScene();
        
        // Boucle de rendu
        engine.runRenderLoop(() => {
            let delta = targetAngleY - smoothedAngleY;
            // G√®re le passage de 360¬∞ √† 0¬∞
            if (Math.abs(delta) > 180) {
                delta -= Math.sign(delta) * 360;
            }
            
            smoothedAngleY += delta * smoothingFactor;
            scene.activeCamera.rotation.y = BABYLON.Tools.ToRadians(smoothedAngleY);
            
            scene.render();
        });

        // Redimensionnement
        window.addEventListener('resize', () => {
            engine.resize();
        });

        // Support mobile
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
